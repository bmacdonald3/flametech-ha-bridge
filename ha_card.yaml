# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# iFlame Fireplace â€” Compact Card + Browser Mod Popup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Same compact grid tile as before. Tap opens browser_mod popup
# with full fireplace controls.
#
# Requires: custom:button-card, browser_mod (HACS)

type: custom:button-card
entity: switch.iflame_fireplace_fireplace
name: Fireplace
grid_options:
  rows: 2
  columns: 4
show_label: true
tap_action:
  action: fire-dom-event
  browser_mod:
    service: browser_mod.popup
    data:
      title: " "
      size: normal
      content:
        type: vertical-stack
        cards:
          # â”€â”€ Status Header â”€â”€
          - type: custom:button-card
            entity: switch.iflame_fireplace_fireplace
            show_name: false
            show_icon: true
            show_label: true
            show_state: false
            icon: |
              [[[
                var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
                if (mode === 'off') return 'mdi:fireplace-off';
                return 'mdi:fireplace';
              ]]]
            label: |
              [[[
                var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
                var at = states['sensor.iflame_fireplace_fireplace_temperature']?.state;
                var climate = states['climate.iflame_fireplace_fireplace_thermostat'];
                var target = climate?.attributes?.temperature;
                var current = (at && at !== 'unknown' && at !== 'unavailable') ? parseFloat(at).toFixed(1) : '--';
                var targetStr = (target !== undefined && target !== null) ? Math.round(target) : '--';
                if (mode === 'off') return 'Off Â· ' + current + 'Â°F';
                if (mode === 'thermostat') return 'Thermostat Â· ' + current + 'Â° â†’ ' + targetStr + 'Â°F';
                return 'Simple Â· ' + current + 'Â°F';
              ]]]
            styles:
              card:
                - background: |
                    [[[
                      var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
                      if (mode === 'thermostat') return 'rgba(200, 100, 0, 0.15)';
                      if (mode === 'simple') return 'rgba(200, 100, 0, 0.22)';
                      return 'var(--card-background-color)';
                    ]]]
                - border-radius: 12px
                - padding: 16px
              icon:
                - width: 40px
                - color: |
                    [[[
                      var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
                      if (mode === 'off') return 'var(--disabled-text-color)';
                      return 'rgb(255, 140, 30)';
                    ]]]
                - filter: |
                    [[[
                      var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
                      if (mode === 'off') return 'none';
                      return 'drop-shadow(0 0 4px rgba(255,120,0,0.7))';
                    ]]]
              label:
                - font-size: 15px
                - font-weight: 500

          # â”€â”€ Power Toggle â”€â”€
          - type: custom:button-card
            entity: switch.iflame_fireplace_fireplace
            name: Power
            show_state: true
            icon: mdi:power
            tap_action:
              action: toggle
            styles:
              card:
                - height: 60px
                - border-radius: 12px
              icon:
                - color: |
                    [[[
                      return entity?.state === 'on' ? 'rgb(255, 140, 30)' : 'var(--disabled-text-color)';
                    ]]]

          # â”€â”€ Thermostat â”€â”€
          - type: thermostat
            entity: climate.iflame_fireplace_fireplace_thermostat
            features:
              - type: climate-hvac-modes
                hvac_modes:
                  - "off"
                  - heat
              - type: target-temperature

          # â”€â”€ Flame & Fan Display + Controls â”€â”€
          - type: horizontal-stack
            cards:
              # Flame column
              - type: vertical-stack
                cards:
                  - type: custom:button-card
                    entity: number.iflame_fireplace_fireplace_flame
                    name: "ğŸ”¥ Flame"
                    show_state: true
                    show_icon: false
                    tap_action:
                      action: more-info
                    state_display: |
                      [[[
                        var v = entity?.state;
                        if (v === '0' || v === 'unavailable') return 'Off';
                        if (v === '6') return 'High';
                        return v;
                      ]]]
                    styles:
                      card:
                        - border-radius: 12px
                        - height: 65px
                      name:
                        - font-size: 12px
                        - opacity: 0.7
                      state:
                        - font-size: 22px
                        - font-weight: bold
                        - color: |
                            [[[
                              return (entity?.state !== '0') ? 'rgb(255, 140, 30)' : 'var(--disabled-text-color)';
                            ]]]
                  - type: horizontal-stack
                    cards:
                      - type: custom:button-card
                        name: "âˆ’"
                        tap_action:
                          action: call-service
                          service: number.set_value
                          service_data:
                            entity_id: number.iflame_fireplace_fireplace_flame
                            value: |
                              [[[
                                return Math.max(0, parseInt(states['number.iflame_fireplace_fireplace_flame']?.state || '0') - 1);
                              ]]]
                        styles:
                          card:
                            - height: 44px
                            - border-radius: 12px
                          name:
                            - font-size: 20px
                            - font-weight: bold
                      - type: custom:button-card
                        name: "+"
                        tap_action:
                          action: call-service
                          service: number.set_value
                          service_data:
                            entity_id: number.iflame_fireplace_fireplace_flame
                            value: |
                              [[[
                                return Math.min(6, parseInt(states['number.iflame_fireplace_fireplace_flame']?.state || '0') + 1);
                              ]]]
                        styles:
                          card:
                            - height: 44px
                            - border-radius: 12px
                          name:
                            - font-size: 20px
                            - font-weight: bold

              # Fan column
              - type: vertical-stack
                cards:
                  - type: custom:button-card
                    entity: number.iflame_fireplace_fireplace_fan
                    name: "ğŸ’¨ Fan"
                    show_state: true
                    show_icon: false
                    tap_action:
                      action: more-info
                    state_display: |
                      [[[
                        var v = entity?.state;
                        if (v === '0' || v === 'unavailable') return 'Off';
                        if (v === '6') return 'High';
                        return v;
                      ]]]
                    styles:
                      card:
                        - border-radius: 12px
                        - height: 65px
                      name:
                        - font-size: 12px
                        - opacity: 0.7
                      state:
                        - font-size: 22px
                        - font-weight: bold
                        - color: |
                            [[[
                              return (entity?.state !== '0') ? 'rgb(100, 180, 255)' : 'var(--disabled-text-color)';
                            ]]]
                  - type: horizontal-stack
                    cards:
                      - type: custom:button-card
                        name: "âˆ’"
                        tap_action:
                          action: call-service
                          service: number.set_value
                          service_data:
                            entity_id: number.iflame_fireplace_fireplace_fan
                            value: |
                              [[[
                                return Math.max(0, parseInt(states['number.iflame_fireplace_fireplace_fan']?.state || '0') - 1);
                              ]]]
                        styles:
                          card:
                            - height: 44px
                            - border-radius: 12px
                          name:
                            - font-size: 20px
                            - font-weight: bold
                      - type: custom:button-card
                        name: "+"
                        tap_action:
                          action: call-service
                          service: number.set_value
                          service_data:
                            entity_id: number.iflame_fireplace_fireplace_fan
                            value: |
                              [[[
                                return Math.min(6, parseInt(states['number.iflame_fireplace_fireplace_fan']?.state || '0') + 1);
                              ]]]
                        styles:
                          card:
                            - height: 44px
                            - border-radius: 12px
                          name:
                            - font-size: 20px
                            - font-weight: bold

          # â”€â”€ Lights Row â”€â”€
          - type: horizontal-stack
            cards:
              # Ember toggle
              - type: custom:button-card
                entity: switch.iflame_fireplace_fireplace_ember_light
                name: Ember Light
                icon: mdi:fire-circle
                show_state: false
                tap_action:
                  action: toggle
                styles:
                  card:
                    - height: 70px
                    - border-radius: 12px
                  icon:
                    - color: |
                        [[[
                          return entity?.state === 'on' ? 'rgb(255, 100, 20)' : 'var(--disabled-text-color)';
                        ]]]
                    - filter: |
                        [[[
                          return entity?.state === 'on' ? 'drop-shadow(0 0 4px rgba(255,80,0,0.6))' : 'none';
                        ]]]
                  name:
                    - font-size: 12px

              # Overhead with level
              - type: vertical-stack
                cards:
                  - type: custom:button-card
                    entity: number.iflame_fireplace_fireplace_overhead_lights
                    name: Overhead
                    show_state: true
                    icon: mdi:ceiling-light
                    tap_action:
                      action: more-info
                    state_display: |
                      [[[
                        var v = entity?.state;
                        if (v === '0' || v === 'unavailable') return 'Off';
                        return v + '/5';
                      ]]]
                    styles:
                      card:
                        - height: 70px
                        - border-radius: 12px
                      icon:
                        - color: |
                            [[[
                              return (entity?.state !== '0') ? 'rgb(255, 220, 100)' : 'var(--disabled-text-color)';
                            ]]]
                        - filter: |
                            [[[
                              return (entity?.state !== '0') ? 'drop-shadow(0 0 4px rgba(255,200,50,0.5))' : 'none';
                            ]]]
                      name:
                        - font-size: 12px

          # â”€â”€ Overhead +/- â”€â”€
          - type: horizontal-stack
            cards:
              - type: custom:button-card
                show_icon: false
                show_name: false
                styles:
                  card:
                    - height: 1px
                    - background: transparent
                    - box-shadow: none
              - type: custom:button-card
                name: "ğŸ’¡ âˆ’"
                tap_action:
                  action: call-service
                  service: number.set_value
                  service_data:
                    entity_id: number.iflame_fireplace_fireplace_overhead_lights
                    value: |
                      [[[
                        return Math.max(0, parseInt(states['number.iflame_fireplace_fireplace_overhead_lights']?.state || '0') - 1);
                      ]]]
                styles:
                  card:
                    - height: 40px
                    - border-radius: 12px
                  name:
                    - font-size: 16px
              - type: custom:button-card
                name: "ğŸ’¡ +"
                tap_action:
                  action: call-service
                  service: number.set_value
                  service_data:
                    entity_id: number.iflame_fireplace_fireplace_overhead_lights
                    value: |
                      [[[
                        return Math.min(5, parseInt(states['number.iflame_fireplace_fireplace_overhead_lights']?.state || '0') + 1);
                      ]]]
                styles:
                  card:
                    - height: 40px
                    - border-radius: 12px
                  name:
                    - font-size: 16px

          # â”€â”€ Split Flow Toggle â”€â”€
          - type: custom:button-card
            entity: switch.iflame_fireplace_fireplace_split_flow
            name: |
              [[[
                return entity?.state === 'on' ? 'Split Flow: Front + Back' : 'Split Flow: Front Only';
              ]]]
            icon: mdi:arrow-split-vertical
            show_state: false
            tap_action:
              action: toggle
            styles:
              card:
                - height: 55px
                - border-radius: 12px
              icon:
                - color: |
                    [[[
                      return entity?.state === 'on' ? 'rgb(100, 180, 255)' : 'var(--disabled-text-color)';
                    ]]]
              name:
                - font-size: 13px

# â”€â”€ Compact Card Styles (outer button-card) â”€â”€
icon: |
  [[[
    var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
    if (mode === 'off') return 'mdi:fireplace-off';
    return 'mdi:fireplace';
  ]]]
label: |
  [[[
    var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
    var at = states['sensor.iflame_fireplace_fireplace_temperature']?.state;
    var climate = states['climate.iflame_fireplace_fireplace_thermostat'];
    var target = climate?.attributes?.temperature;
    var current = (at && at !== 'unknown' && at !== 'unavailable') ? Math.round(parseFloat(at)) : '--';
    var targetStr = (target !== undefined && target !== null) ? Math.round(target) : '--';
    var flame = states['number.iflame_fireplace_fireplace_flame']?.state;
    var fan = states['number.iflame_fireplace_fireplace_fan']?.state;

    if (mode === 'off') return 'Off Â· ' + current + 'Â°';
    if (mode === 'thermostat') return 'Thermo Â· ' + current + '/' + targetStr + 'Â°';
    var f = (flame && flame !== 'unknown') ? flame : '-';
    var fn = (fan && fan !== 'unknown') ? fan : '-';
    return 'On Â· F' + f + ' Fan ' + fn;
  ]]]
styles:
  card:
    - height: 115px
    - padding: 12px
    - border-radius: 10px
    - border: 2px solid
    - transition: all 0.3s ease
    - background: |
        [[[
          var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
          if (mode === 'thermostat') return 'rgba(200, 100, 0, 0.15)';
          if (mode === 'simple') return 'rgba(200, 100, 0, 0.22)';
          return 'var(--card-background-color)';
        ]]]
    - border-color: |
        [[[
          var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
          if (mode === 'off') return 'transparent';
          if (mode === 'thermostat') return 'rgba(255, 160, 40, 0.8)';
          return 'rgba(255, 140, 0, 0.95)';
        ]]]
    - box-shadow: |
        [[[
          var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
          if (mode === 'off') return 'none';
          if (mode === 'thermostat') return '0 0 10px 2px rgba(255, 140, 40, 0.35)';
          return '0 0 14px 3px rgba(255, 120, 0, 0.5)';
        ]]]
  icon:
    - color: |
        [[[
          var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
          if (mode === 'off') return 'var(--disabled-text-color)';
          return 'rgb(255, 140, 30)';
        ]]]
    - filter: |
        [[[
          var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
          if (mode === 'off') return 'none';
          return 'drop-shadow(0 0 3px rgba(255,120,0,0.8)) drop-shadow(0 0 6px rgba(255,120,0,0.5))';
        ]]]
    - animation: |
        [[[
          var mode = states['sensor.iflame_fireplace_fireplace_mode']?.state;
          if (mode === 'off') return 'none';
          if (mode === 'thermostat') return 'flicker 3s ease-in-out infinite';
          return 'flicker 2s ease-in-out infinite';
        ]]]
extra_styles: |
  @keyframes flicker {
    0%   { transform: scale(1.00); filter: drop-shadow(0 0 2px rgba(255,120,0,0.8)); }
    25%  { transform: scale(1.04); filter: drop-shadow(0 0 5px rgba(255,120,0,0.9)); }
    50%  { transform: scale(1.06); filter: drop-shadow(0 0 8px rgba(255,120,0,0.6)); }
    75%  { transform: scale(1.03); filter: drop-shadow(0 0 4px rgba(255,120,0,0.85)); }
    100% { transform: scale(1.00); filter: drop-shadow(0 0 2px rgba(255,120,0,0.8)); }
  }
